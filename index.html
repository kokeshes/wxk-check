<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#111111" />
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="styles.css" />
  <title>WXK Check</title>

  <!-- 黒背景 + UI補正 + チップ完全版（styles.cssが何でも壊れにくい） -->
  <style>
    :root { color-scheme: dark; }

    body { background:#0f0f10; color:#f2f2f2; }
    header { background:#0f0f10; }

    /* 文字 */
    .muted { opacity: .78; }
    .hint { font-size: .92rem; line-height: 1.35; }

    /* レイアウト */
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .divider { height:1px; background: rgba(255,255,255,.10); margin: 12px 0; }
    .spacer { height: 10px; }

    /* カード */
    .card {
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      padding: 12px;
    }

    /* 入力部品 */
    input, textarea, select, button {
      background: rgba(255,255,255,.06);
      color:#f2f2f2;
      border:1px solid rgba(255,255,255,.12);
      border-radius: 12px;
      padding: 10px 12px;
      outline: none;
    }
    textarea { border-radius: 14px; }
    input:focus, textarea:focus, select:focus {
      border-color: rgba(255,255,255,.32);
      box-shadow: 0 0 0 3px rgba(255,255,255,.08);
    }

    /* ボタン */
    button { cursor:pointer; }
    button.primary { background: rgba(255,255,255,.16); }
    button.primary:hover { background: rgba(255,255,255,.22); }
    button.danger { background: rgba(255,77,109,.18); border-color: rgba(255,77,109,.35); }
    button.danger:hover { background: rgba(255,77,109,.26); }

    /* ファイル */
    label.file { cursor:pointer; }
    label.file input { display:none; }

    /* -----------------------------
       ERRチップ：完全版（JS無変更）
       ----------------------------- */

    /* chipsコンテナ：スマホで詰まる */
    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:stretch;
    }

    /* チップ共通（既存styles.cssのchip指定を確実に上書き） */
    button.chip {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color: #f2f2f2;
      font-size: .85rem;
      line-height: 1.15;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      transition: transform .05s ease, background .12s ease, border-color .12s ease, color .12s ease;
      max-width: 100%;
    }

    button.chip:hover {
      background: rgba(255,255,255,.11);
      border-color: rgba(255,255,255,.28);
    }
    button.chip:active { transform: translateY(1px); }

    /* active（選択中）：反転＋くっきり */
    button.chip.active {
      background: rgba(255,255,255,.26);
      color: #0f0f10;
      border-color: rgba(255,255,255,.58);
    }

    /* チップを“ちょい整列”させる（スマホで2列ベース） */
    @media (max-width: 520px){
      button.chip{
        flex: 1 1 calc(50% - 8px);
        text-align:center;
      }
    }
    @media (max-width: 360px){
      button.chip{ flex: 1 1 100%; }
    }
    @media (min-width: 521px){
      button.chip{ flex: 0 0 auto; }
    }

    /* 色分け（data-code による） */

    /* E0000（平常運転）は淡く */
    button.chip[data-code="E0000"]{
      background: rgba(255,255,255,.04);
      border-color: rgba(255,255,255,.10);
      color: rgba(242,242,242,.80);
    }
    button.chip[data-code="E0000"].active{
      background: rgba(255,255,255,.18);
      color:#0f0f10;
      border-color: rgba(255,255,255,.45);
    }

    /* E系（Info/Medが多い）を少し青み */
    button.chip[data-code^="E"]{
      border-color: rgba(170,210,255,.24);
      background: rgba(170,210,255,.07);
    }
    button.chip[data-code^="E"]:hover{
      background: rgba(170,210,255,.11);
      border-color: rgba(170,210,255,.32);
    }
    button.chip[data-code^="E"].active{
      background: rgba(170,210,255,.28);
      color:#0f0f10;
      border-color: rgba(170,210,255,.55);
    }

    /* Critical（赤）：概ね該当するもの */
    button.chip[data-code="001"],
    button.chip[data-code="002"],
    button.chip[data-code="202"],
    button.chip[data-code="203"],
    button.chip[data-code="204"],
    button.chip[data-code="E700"],
    button.chip[data-code="E710"],
    button.chip[data-code="E220"]{
      background: rgba(255,77,109,.10);
      border-color: rgba(255,77,109,.32);
    }
    button.chip[data-code="001"].active,
    button.chip[data-code="002"].active,
    button.chip[data-code="202"].active,
    button.chip[data-code="203"].active,
    button.chip[data-code="204"].active,
    button.chip[data-code="E700"].active,
    button.chip[data-code="E710"].active,
    button.chip[data-code="E220"].active{
      background: rgba(255,77,109,.30);
      color:#0f0f10;
      border-color: rgba(255,77,109,.55);
    }

    /* High（橙） */
    button.chip[data-code="003"],
    button.chip[data-code="004"],
    button.chip[data-code="005"],
    button.chip[data-code="101"],
    button.chip[data-code="102"],
    button.chip[data-code="104"],
    button.chip[data-code="201"],
    button.chip[data-code="303"],
    button.chip[data-code="E210"],
    button.chip[data-code="E320"],
    button.chip[data-code="E330"],
    button.chip[data-code="E410"],
    button.chip[data-code="E510"]{
      background: rgba(255,178,71,.10);
      border-color: rgba(255,178,71,.30);
    }
    button.chip[data-code="003"].active,
    button.chip[data-code="004"].active,
    button.chip[data-code="005"].active,
    button.chip[data-code="101"].active,
    button.chip[data-code="102"].active,
    button.chip[data-code="104"].active,
    button.chip[data-code="201"].active,
    button.chip[data-code="303"].active,
    button.chip[data-code="E210"].active,
    button.chip[data-code="E320"].active,
    button.chip[data-code="E330"].active,
    button.chip[data-code="E410"].active,
    button.chip[data-code="E510"].active{
      background: rgba(255,178,71,.26);
      color:#0f0f10;
      border-color: rgba(255,178,71,.55);
    }

    /* Med（緑） */
    button.chip[data-code="301"],
    button.chip[data-code="E100"],
    button.chip[data-code="E110"],
    button.chip[data-code="E120"],
    button.chip[data-code="E130"],
    button.chip[data-code="E200"],
    button.chip[data-code="E300"],
    button.chip[data-code="E310"],
    button.chip[data-code="E400"],
    button.chip[data-code="E500"]{
      background: rgba(170,255,170,.08);
      border-color: rgba(170,255,170,.24);
    }
    button.chip[data-code="301"].active,
    button.chip[data-code="E100"].active,
    button.chip[data-code="E110"].active,
    button.chip[data-code="E120"].active,
    button.chip[data-code="E130"].active,
    button.chip[data-code="E200"].active,
    button.chip[data-code="E300"].active,
    button.chip[data-code="E310"].active,
    button.chip[data-code="E400"].active,
    button.chip[data-code="E500"].active{
      background: rgba(170,255,170,.22);
      color:#0f0f10;
      border-color: rgba(170,255,170,.45);
    }

    /* リスト表示の最低限 */
    ul.list { list-style:none; padding-left:0; }
    ul.list > li.card { margin: 10px 0; }

    /* aリンク */
    a { color: rgba(170,210,255,.95); }
    a:hover { opacity: .9; }
    /* インポート（label.file）を“ボタン見た目”にする：白地白文字を潰す */
label.file{
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 12px;
  border-radius: 12px;
  background: rgba(255,255,255,.06);
  color: #f2f2f2;
  border: 1px solid rgba(255,255,255,.12);
  user-select: none;
}

label.file:hover{
  background: rgba(255,255,255,.11);
  border-color: rgba(255,255,255,.28);
}
label.file:active{
  transform: translateY(1px);
}

/* 念のため：中の文字色が吸われるケースを封じる */
label.file, label.file *{
  color: #f2f2f2 !important;
}

  </style>
</head>

<body>
  <header>
    <h1>WXK Check</h1>
    <nav>
      <button data-tab="log" class="active">入力</button>
      <button data-tab="list">履歴</button>
      <button data-tab="diag">診断</button>
      <button data-tab="settings">設定</button>
    </nav>
  </header>

  <main>

    <!-- 入力（★クラウドUIを撤去：1分入力に集中） -->
    <section id="tab-log" class="tab active">
      <h2>今日の入力（1分）</h2>

      <label>プロファイル
        <select id="profile">
          <option value="恋愛">恋愛</option>
          <option value="仕事/研究">仕事/研究</option>
          <option value="相談/友人">相談/友人</option>
          <option value="単独">単独</option>
          <option value="その他">その他</option>
        </select>
      </label>

      <label>過負荷（0–5）
        <input id="overload" type="range" min="0" max="5" step="1" value="2" />
        <span id="overloadVal">2</span>
      </label>

      <fieldset>
        <legend>ERR候補（複数選択）</legend>
        <div class="chips" id="errChips"></div>
      </fieldset>

      <label>症状メモ（任意）
        <textarea id="note" rows="4" placeholder="例：常駐期待っぽい／夜に結論出したくなる…"></textarea>
      </label>

      <fieldset>
        <legend>即応（やった？）</legend>
        <label><input type="checkbox" id="actDistance"> 距離復帰（返信/接触を落とす）</label>
        <label><input type="checkbox" id="actScope"> 範囲・期限を宣言</label>
        <label><input type="checkbox" id="actBody"> 身体接地（風呂/運動/食/睡眠）</label>
        <label><input type="checkbox" id="actStop"> 判断停止（夜は極力結論を出さない）</label>
      </fieldset>

      <label>次回の境界線宣言（テンプレ）
        <select id="boundaryTpl">
          <option value="">-- 選ぶ --</option>
          <option value="常駐はできない。範囲と期限を決めたい。">この調子で常駐はできない。範囲と期限を決めたい。</option>
          <option value="今日は判断しない。明日話そう。">今日は判断しない。明日話そう。</option>
          <option value="試し行為（嫉妬/沈黙）は不可。言葉で確認したい。">試し行為は不可。言葉で確認したい。</option>
          <option value="その決定はあなたに返したい。あなたはどうしたい？">決定はあなたに返したい。あなたはどうしたい？</option>
        </select>
      </label>

      <label>境界線メモ（任意）
        <input id="boundaryNote" type="text" placeholder="例：週1で相談、30分まで など" />
      </label>

      <button id="saveBtn" class="primary">保存</button>
      <p id="saveMsg" class="muted"></p>

      <div class="spacer"></div>
      <div class="muted hint card">
        クラウド共有は「設定」でログインすると自動で有効になります（入力はそのまま1分でOK）。
      </div>
    </section>

    <!-- 履歴（★ここに ownerSelect を集約） -->
    <section id="tab-list" class="tab">
      <h2>履歴</h2>

      <div class="card" style="margin-bottom:12px;">
        <div class="row">
          <label class="muted">閲覧対象：</label>
          <select id="ownerSelect"></select>
          <span class="muted hint">（ローカル / 自分クラウド / 共有）</span>
        </div>
        <div id="authMsg" class="muted hint" style="margin-top:8px;">
          Supabase未設定：ローカルのみ動作中（設定でログインすると共有できます）
        </div>
      </div>

      <div class="row">
        <button id="exportBtn" type="button">エクスポート（JSON）</button>
        <label class="file">
          インポート
          <input id="importFile" type="file" accept="application/json" />
        </label>
      </div>

      <ul id="logList" class="list"></ul>
    </section>

    <!-- 診断 -->
    <section id="tab-diag" class="tab">
      <h2>故障診断（YES/NO）</h2>
      <div id="diagBox"></div>
      <div id="diagResult" class="card"></div>
    </section>

    <!-- 設定（★ログインUI＋共有管理をここに集約） -->
    <section id="tab-settings" class="tab">
      <h2>設定</h2>

      <p>
        <a href="./manual/index.html">取扱説明書（完全版）を開く</a>
      </p>

      <!-- ★ログインUI（OTP）：ここに移動 -->
      <div class="card" id="authCard" style="margin: 12px 0;">
        <div style="font-weight:700; margin-bottom:8px;">クラウド共有（Supabaseログイン）</div>
        <div class="muted hint" style="margin-bottom:10px;">
          メールにログインリンク（OTP）を送ります。ログイン後は保存時に自動でクラウド同期されます。
        </div>

        <div class="row">
          <input id="authEmail" type="email" placeholder="you@example.com" style="flex:1; min-width:220px;" />
          <button id="loginBtn" class="primary" type="button">ログインリンク送信</button>
          <button id="logoutBtn" type="button">ログアウト</button>
        </div>
      </div>

      <!-- ★共有（閲覧者）管理UI -->
      <div class="card" style="margin: 12px 0;">
        <div style="font-weight:700; margin-bottom:8px;">履歴共有（閲覧者の追加）</div>
        <div class="muted hint" style="margin-bottom:10px;">
          オーナー（自分）のログを、指定メールに「閲覧専用」で共有します。<br>
          ※ログインしていないと使えません。
        </div>

        <div class="row">
          <input id="viewerEmail" type="email" placeholder="viewer@example.com" style="flex:1; min-width:220px;" />
          <button id="addViewerBtn" class="primary" type="button">閲覧者を追加</button>
        </div>

        <div class="divider"></div>
        <ul id="viewerList" class="list"></ul>
      </div>

      <button id="wipeBtn" class="danger" type="button">全データ削除</button>
      <p class="muted">端末内保存（iCloud同期なし）。必要ならExportでバックアップ。</p>
    </section>
  </main>

  <!-- ★最重要：supabase-js → app.js の順 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="app.js"></script>
</body>
</html>
